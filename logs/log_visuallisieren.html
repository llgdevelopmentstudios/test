<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log</title>
</head>
<style>
    h1, h2, h3, h4{
        text-decoration: underline;
    }
    h1, h2{
        text-align: center;
    }
    div{
        width: 75%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid black;
        box-shadow: 10px 5px 30px black;
    }
    button{
        font-size: 20px;
        background-color: rgb(0, 110, 255);
        border-radius: 10px;
        border: 1px solid black;
    }
    button:hover{
        filter: brightness(0.8);
    }
</style>
<body>
    <h1>Visuallisierte Logs:</h1>
    <div id="seitenaufrufe_master_div">
        <div>
            <button onclick="seitenaufrufe_neuladen_function()">Seitenaufrufe neuladen</button>
        </div><hr>
        <canvas id="seitenaufrufe_diagramm"></canvas><hr>
        <div id="seitenaurufe_ip_master"></div>
    </div>
    <script>
        // Holen Sie das Canvas-Element
        var canvas = document.getElementById('seitenaufrufe_diagramm');
        canvas.style.width = "100%";
        canvas.style.height = "500px";
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        var ctx = canvas.getContext('2d');
        window.onload = function() {
            verarbeite_daten();
        }
        async function verarbeite_daten() {
            var response = await fetch('seitenaufrufe.json');
            var response_text = await response.text();
            var response_json = await JSON.parse(await response_text);
            var uhrzeiten = {
                1: 0,
                2: 0,
                3: 0,
                4: 0,
                5: 0,
                6: 0,
                7: 0,
                8: 0,
                9: 0,
                10: 0,
                11: 0,
                12: 0,
                13: 0,
                14: 0,
                15: 0,
                16: 0,
                17: 0,
                18: 0,
                19: 0,
                20: 0,
                21: 0,
                22: 0,
                23: 0,
                0: 0
            };
            await response_json.forEach(element => {
                var Datum = new Date(element.time);
                var stunde = Datum.getHours();
                uhrzeiten[stunde]++;
            });

            console.log(await uhrzeiten);
            var data = {
                labels: ['1', '2', '3', '4', '5','6', '7', '8', '9', '10','11', '12', '13', '14', '15','16', '17', '18', '19', '20','21', '22', '23', '0'],
                datasets: [{
                    label: 'Data',
                    data: Object.values(uhrzeiten),
                    color: 'rgb(75, 192, 192)'
                }]
            };
           await zeichneLiniendiagramm(data)
        }
        // Funktion zum Zeichnen des Liniendiagramms
        function zeichneLiniendiagramm(data) {
            var width = canvas.width;
            var height = canvas.height;
            ctx.lineWidth = 10;
            var padding = 25;

            // Zeichnen Sie die X- und Y-Achsen
            ctx.beginPath();
            ctx.moveTo(0, height - padding);
            ctx.lineTo(width, height - padding);
            ctx.moveTo(0, 0);
            ctx.lineTo(0, height - padding);
            ctx.stroke();

            // Anzahl der Datenpunkte
            var numPoints = data.labels.length;

            // Abstand zwischen den Punkten auf der X-Achse
            var pointSpacing = width / (numPoints + 1);

            // Maximale Datenwert
            var maxDataValue = Math.max.apply(null, data.datasets[0].data);
            console.log(maxDataValue);

            // Faktor zur Skalierung der Y-Achse
            var yScale = (height - padding) / maxDataValue;

            // Zeichnen Sie die Linie
            ctx.beginPath();
            ctx.strokeStyle = data.datasets[0].color;

            for (var i = 0; i < numPoints; i++) {
                var x = (i + 1) * pointSpacing;
                var y = (height - padding) - data.datasets[0].data[i] * yScale;
                var y2 = i * yScale;
                var y3 = (height - padding) - data.datasets[0].data[i - 1] * yScale;
                ctx.strokeStyle = "gray";
                ctx.lineWidth = 3;
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height - padding);
                ctx.moveTo(0, (height - padding) - (y2 + yScale));
                ctx.lineTo(width, (height - padding) - (y2 + yScale));
                ctx.stroke();

                ctx.beginPath();
                ctx.lineWidth = 10;
                ctx.strokeStyle = data.datasets[0].color;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                // Markieren Sie die Datenpunkte
                //ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = data.datasets[0].color;
                ctx.moveTo(x - pointSpacing, y3);
                ctx.lineTo(x, y);
                ctx.stroke();

                ctx.beginPath();
                //ctx.fill();
                ctx.font = '20px Arial';
                ctx.fillStyle = 'black';
                ctx.fillText(data.labels[i], x, height - 5);
                ctx.fillText(data.datasets[0].data[i], x, 20)
                ctx.fillText(i * Math.round((maxDataValue / yScale) *10), 10, (height - padding) - y2);
                ctx.stroke();
            }

            ctx.stroke();
        }
        async function seitenaufrufe_neuladen_function() {
            var oldInput = document.getElementById("seitenaufrufe_diagramm"); 
                        
            var newInput = document.createElement("canvas"); 
            newInput.id = oldInput.id; 
            newInput.name = oldInput.name; 
            newInput.style.cssText = oldInput.style.cssText; 
                        
            oldInput.parentNode.replaceChild(newInput, oldInput); 
            canvas = document.getElementById("seitenaufrufe_diagramm");
            canvas.style.width = "100%";
            canvas.style.height = "500px";
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx = canvas.getContext('2d');
            verarbeite_daten();
        }
    </script>
</body>
</html>